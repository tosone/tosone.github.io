<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Golang Memory Align - Tosone&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Tosone" /><meta name="description" content="Golang Memory Align" />
<meta name="keywords" content="Golang, Memory" />







<meta name="generator" content="Hugo 0.93.2" />


<link rel="canonical" href="https://www.tosone.cn/post/golang-mem-align/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.fa4b2b9f31b5c6d0b683db81157a9226e17b06e61911791ab547242a4a0556f2.css" integrity="sha256-&#43;ksrnzG1xtC2g9uBFXqSJuF7BuYZEXkatUckKkoFVvI=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Golang Memory Align" />
<meta property="og:description" content="Golang Memory Align" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.tosone.cn/post/golang-mem-align/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-10-24T15:53:21+08:00" />
<meta property="article:modified_time" content="2020-10-24T15:53:21+08:00" />

<meta itemprop="name" content="Golang Memory Align">
<meta itemprop="description" content="Golang Memory Align"><meta itemprop="datePublished" content="2020-10-24T15:53:21+08:00" />
<meta itemprop="dateModified" content="2020-10-24T15:53:21+08:00" />
<meta itemprop="wordCount" content="4546">
<meta itemprop="keywords" content="Golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang Memory Align"/>
<meta name="twitter:description" content="Golang Memory Align"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Tosone</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.tosone.cn/">This is Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.tosone.cn/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.tosone.cn/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.tosone.cn/categories/">Categories</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Tosone
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.tosone.cn/">This is Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.tosone.cn/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.tosone.cn/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.tosone.cn/categories/">Categories</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Golang Memory Align</h1>
      
      <div class="post-meta">
        <time datetime="2020-10-24" class="post-time">
          2020-10-24
        </time>
        <div class="post-category">
            <a href="https://www.tosone.cn/categories/develop/"> Develop </a>
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    

    
    <div class="post-content">
      <p>操作系统并非一个字节一个字节访问内存，而是按 2, 4, 8 这样的字长来访问。因此，当 CPU 从存储器读数据到寄存器，或者从寄存器写数据到存储器，IO 的数据长度通常是字长。如 32 位系统访问粒度是 4 字节，64 位系统的是 8 字节。</p>
<p>当被访问的数据长度为 n 字节且该数据地址为n字节对齐，那么操作系统就可以高效地一次定位到数据，无需多次读取、处理对齐运算等额外操作。</p>
<p>数据结构应该尽可能地在自然边界上对齐。如果访问未对齐的内存，CPU需要做两次内存访问。</p>
<blockquote>
<p>原文链接：<a href="https://xie.infoq.cn/article/594a7f54c639accb53796cfc7">https://xie.infoq.cn/article/594a7f54c639accb53796cfc7</a></p>
</blockquote>
<p>下面是腾讯的面试题：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">S</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">A</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">	<span class="nx">B</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">	<span class="nx">C</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">	<span class="nx">D</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">	<span class="nx">E</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的 struct S，占用多大的内存？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Offsetof</span><span class="p">(</span><span class="nx">S</span><span class="p">{}.</span><span class="nx">E</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">S</span><span class="p">{}.</span><span class="nx">E</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">S</span><span class="p">{}))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先，我们可以明确S的是8字节对齐的，因此我给出的答案是 32。但是很明显，答案并不是 32。先看下正确答案。终端输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">32
</span></span><span class="line"><span class="cl">0
</span></span><span class="line"><span class="cl">40
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，S.E 的偏移量 offset 是32，并且 size 确实是 0，但是 S 实例的 size 却是 40。说明 S.E 后面隐藏着一个 8 字节的 padding。</p>
<h3 id="社区解答">社区解答</h3>
<p>那为什么需要这个 padding 呢？在 github 上面查到了相关的 <a href="https://github.com/golang/go/issues/38194">issue</a>，看见社区大佬的回复是这样的：</p>
<blockquote>
<p>Trailing zero-sized struct fields are padded because if they weren’t, &amp;C.E would point to an invalid memory location.</p>
</blockquote>
<p>结构体尾部 size 为 0 的变量会被分配内存空间进行填充，原因是如果不给它分配内存，该变量指针将指向一个非法的内存空间。</p>
<p>并且还给了个相关的 <a href="https://github.com/golang/go/issues/9401">issue</a> 地址：</p>
<blockquote>
<p>If a non-zero-size struct contains a final zero-size field f, the address &amp;x.f may point beyond the allocation for the struct. This could cause a memory leak or a crash in the garbage collector (invalid pointer found).</p>
</blockquote>
<p>一个非空结构体包含有尾部 size 为 0 的变量，如果不给它分配内存，那么该变量的指针地址将指向一个超出该结构体内存范围的内存空间。这可能会导致内存泄漏，或者在内存垃圾回收过程中，程序 crash 掉。</p>
<h3 id="原理">原理</h3>
<h4 id="为什么要对齐">为什么要对齐</h4>
<p>操作系统并非一个字节一个字节访问内存，而是按 2, 4, 8 这样的字长来访问。因此，当 CPU 从存储器读数据到寄存器，或者从寄存器写数据到存储器，IO 的数据长度通常是字长。如 32 位系统访问粒度是 4 字节，64 位系统的是 8 字节。</p>
<p>当被访问的数据长度为 n 字节且该数据地址为n字节对齐，那么操作系统就可以高效地一次定位到数据，无需多次读取、处理对齐运算等额外操作。</p>
<p>数据结构应该尽可能地在自然边界上对齐。如果访问未对齐的内存，CPU需要做两次内存访问。</p>
<p>看下 Go 官方文档 Size and alignment guarantees 对于 Go 数据类型的大小保证和对齐保证：</p>
<p><img src="https://tc.tosone.cn/20201024161902.png" alt="img"></p>
<p>在 Go 中，如果两个值的类型为同一种类的类型，并且它们的类型的种类不为接口、数组和结构体，则这两个值的尺寸总是相等的。</p>
<p>目前（Go 1.14），至少对于官方标准编译器来说，任何一个特定类型的所有值的尺寸都是相同的。所以我们也常说一个值的尺寸为此值的类型的尺寸。</p>
<p>下表列出了各种种类的类型的尺寸（对标准编译器 1.14 来说）:</p>
<p><img src="https://tc.tosone.cn/20201024161748.png" alt="img"></p>
<p>一个结构体类型的尺寸取决于它的各个字段的类型尺寸和这些字段的排列顺序。为了程序执行性能，编译器需要保证某些类型的值在内存中存放时必须满足特定的内存地址对齐要求。 地址对齐可能会造成相邻的两个字段之间在内存中被插入填充一些多余的字节。 所以，一个结构体类型的尺寸必定不小于（常常会大于）此结构体类型的各个字段的类型尺寸之和。</p>
<p>一个数组类型的尺寸取决于它的元素类型的尺寸和它的长度。它的尺寸为它的元素类型的尺寸和它的长度的乘积。</p>
<p>struct{} 和 [0]T{} 的大小为 0; 不同的大小为 0 的变量可能指向同一块地址。</p>
<p>Go 官方文档中的对对齐保证的要求只有如下解释：</p>
<p>对于任何类型的变量x，unsafe.Alignof(x) 的结果最小为 1。</p>
<p>对于一个结构体类型的变量 x，unsafe.Alignof(x) 的结果为x的所有字段的对齐保证 unsafe.Alignof(x.f) 中的最大值（但是最小为 1）。</p>
<p>对于一个数组类型的变量 x，unsafe.Alignof(x) 的结果和此数组的元素类型的一个变量的对齐保证相等。</p>
<p><img src="https://tc.tosone.cn/20201024162305.png" alt="img"></p>
<p>类型对齐保证也称为值地址对齐保证。 如果一个类型T的对齐保证为N（一个正整数），则在运行时刻T类型的每个（可寻址的）值的地址都是N的倍数。 我们也可以说类型T的值的地址保证为N字节对齐的。</p>
<p>事实上，每个类型有两个对齐保证。当它被用做结构体类型的字段类型时的对齐保证称为此类型的字段对齐保证，其它情形的对齐保证称为此类型的一般对齐保证。</p>
<p>对于一个类型T，我们可以调用unsafe.Alignof(t)来获得它的一般对齐保证，其中t为一个T类型的非字段值， 也可以调用unsafe.Alignof(x.t)来获得T的字段对齐保证，其中x为一个结构体值并且t为一个类型为T的结构体字段值。</p>
<p>在运行时刻，对于类型为T的一个值t，我们可以调用reflect.TypeOf(t).Align()来获得类型T的一般对齐保证， 也可以调用reflect.TypeOf(t).FieldAlign()来获得T的字段对齐保证。</p>
<p>对于当前的官方Go编译器（1.14版本），一个类型的一般对齐保证和字段对齐保证总是相等的。</p>
<h4 id="重排优化">重排优化</h4>
<p><img src="https://tc.tosone.cn/20201024162347.png" alt="img"></p>
<p>T1,T2内字段最大的都是int64, 大小为 8bytes，对齐按机器字确定，64 位下是 8bytes，所以将按 8bytes 对齐</p>
<p>T1.a 大小 2bytes, 填充 6bytes 使对齐（后边字段已对齐，所以直接填充）</p>
<p>T1.b 大小 8bytes, 已对齐</p>
<p>T1.c 大小 2bytes，填充 6bytes 使对齐（后边无字段，所以直接填充）</p>
<p>总大小为 8+8+8=24</p>
<p>T2中将c提前后，a和c总大小 4bytes,在填充 4bytes 使对齐</p>
<p>总大小为 8+8=16</p>
<p>所以，合理重排字段可以减少填充，使 struct 字段排列更紧密。</p>
<h4 id="零大小字段对齐">零大小字段对齐</h4>
<p>零大小字段（zero sized field）是指struct{}，大小为 0，按理作为字段时不需要对齐，但当在作为结构体最后一个字段（final field）时需要对齐的。即开篇我们讲到的面试题的情况，假设有指针指向这个final zero field, 返回的地址将在结构体之外（即指向了别的内存），如果此指针一直存活不释放对应的内存，就会有内存泄露的问题（该内存不因结构体释放而释放），go会对这种final zero field也做填充，使对齐。当然，有一种情况不需要对这个final zero field做额外填充，也就是这个末尾的上一个字段未对齐，需要对这个字段进行填充时，final zero field就不需要再次填充，而是直接利用了上一个字段的填充。</p>
<p><img src="https://tc.tosone.cn/20201024162445.png" alt="img"></p>
<p>思考: 假如这个 E 不是struct{}，而是 [0]int32 或者 [0]int64，那 unsafe.Sizeof(S{}) 会是多少呢？</p>
<h4 id="64-位字安全访问保证">64 位字安全访问保证</h4>
<p>在 32 位系统上想要原子操作 64 位字（如 uint64）的话，需要由调用方保证其数据地址是 64 位对齐的，否则原子访问会有异常。</p>
<p>拿uint64来说，大小为 8bytes，32 位系统上按 4字节 对齐，64 位系统上按 8字节对齐。在 64 位系统上，8bytes 刚好和其字长相同，所以可以一次完成原子的访问，不被其他操作影响或打断。而 32 位系统，4byte 对齐，字长也为 4bytes，可能出现uint64的数据分布在两个数据块中，需要两次操作才能完成访问。如果两次操作中间有可能别其他操作修改，不能保证原子性。这样的访问方式也是不安全的。</p>
<p>来看下 Golang 一个 <a href="https://github.com/golang/go/issues/6404">issue</a>。</p>
<p><img src="https://tc.tosone.cn/20201024162601.png" alt="img">
<img src="https://tc.tosone.cn/20201024162618.png" alt="img"></p>
<p>Cox大神的解答：</p>
<p><img src="https://tc.tosone.cn/20201024162638.png" alt="img"></p>
<p>在32位系统上，开发者有义务使64位字长的数据的原子访问是64位(8字节)对齐的。在全局变量，结构体和切片的的第一个字长数据可以被认为是64位对齐的。</p>
<h4 id="如何保证呢">如何保证呢？</h4>
<p>变量或开辟的结构体、数组和切片值中的第一个 64 位字可以被认为是 8 字节对齐</p>
<p>开辟的意思是通过声明，make，new 方式创建的，就是说这样创建的 64 位字可以保证是 64 位对齐的。</p>
<h3 id="总结">总结</h3>
<p>内存对齐是为了让 CPU 更高效访问内存中数据</p>
<p>struct 的对齐是：如果类型 t 的对齐保证是 n，那么类型 t 的每个值的地址在运行时必须是 n 的倍数。</p>
<p>即 uintptr(unsafe.Pointer(&amp;x)) % unsafe.Alignof(x) == 0</p>
<p>struct 内字段如果填充过多，可以尝试重排，使字段排列更紧密，减少内存浪费</p>
<p>零大小字段要避免作为 struct 最后一个字段，会有内存浪费</p>
<p>32 位系统上对 64 位字的原子访问要保证其是 8bytes 对齐的；当然如果不必要的话，还是用加锁（mutex）的方式更清晰简单</p>
<p><img src="https://tc.tosone.cn/20201024162753.png" alt="img"></p>
<p>因为s1和s2在内存上是连续的，我们也已知s1的大小是40，那为什么s2的地址相对s1的地址偏移量却是48呢？(0xc0000aa090-0xc0000aa060 = 48)</p>
<p>先给出答案，因为对于s1这个对象，它的大小是40bytes，而go在内存分配时，会从span中拿大于或等于40的最小的span中的一个块给这个对象，而sizeclass中这个块的大小值为48。所以虽然s1的大小是40bytes，但实际分配给这个对象的内存大小是48。</p>
<p>go的内存分配，首先是按照sizeclass划分span，然后每个span中的page又分成一个个小格子(大小相同的对象object)：</p>
<p>span是golang内存管理的基本单位，是由一片连续的8KB(golang page的大小)的页组成的大块内存。</p>
<p>如下图，span由一组连续的页组成，按照一定大小划分成object。</p>
<p><img src="https://tc.tosone.cn/20201024162810.png" alt="img"></p>
<p>每个span管理指定规格（以golang 中的 page为单位）的内存块，内存池分配出不同规格的内存块就是通过span体现出来的，应用程序创建对象就是通过找到对应规格的span来存储的，下面是 mspan结构中的主要部分。</p>
<p><img src="https://tc.tosone.cn/20201024162830.png" alt="img"></p>
<p>那么要想区分不同规格的span，必须要有一个标识，每个span通过spanclass标识属于哪种规格的span，golang的span规格一共有67种，具体如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// go/src/runtime/sizeclasses.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// class： 			 class ID，每个span结构中都有一个class ID, 表示该span可处理的对象类型
</span></span></span><span class="line"><span class="cl"><span class="c1">// bytes/obj：		 该class代表对象的字节数
</span></span></span><span class="line"><span class="cl"><span class="c1">// bytes/span：	 每个span占用堆的字节数，也即页数*页大小
</span></span></span><span class="line"><span class="cl"><span class="c1">// objects: 		  每个span可分配的对象个数，也即（bytes/spans）/（bytes/obj）
</span></span></span><span class="line"><span class="cl"><span class="c1">// waste bytes: 	每个span产生的内存碎片，也即（bytes/spans）%（bytes/obj）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// class  bytes/obj  bytes/span  objects  tail waste  max waste
</span></span></span><span class="line"><span class="cl"><span class="c1">//     1          8        8192     1024           0     87.50%
</span></span></span><span class="line"><span class="cl"><span class="c1">//     2         16        8192      512           0     43.75%
</span></span></span><span class="line"><span class="cl"><span class="c1">//     3         32        8192      256           0     46.88%
</span></span></span><span class="line"><span class="cl"><span class="c1">//     4         48        8192      170          32     31.52%  8192-(48*170)
</span></span></span><span class="line"><span class="cl"><span class="c1">//     5         64        8192      128           0     23.44%
</span></span></span><span class="line"><span class="cl"><span class="c1">//     6         80        8192      102          32     19.07%
</span></span></span><span class="line"><span class="cl"><span class="c1">//     7         96        8192       85          32     15.95%
</span></span></span><span class="line"><span class="cl"><span class="c1">//     8        112        8192       73          16     13.56%
</span></span></span><span class="line"><span class="cl"><span class="c1">//     9        128        8192       64           0     11.72%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    10        144        8192       56         128     11.82%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    11        160        8192       51          32      9.73%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    12        176        8192       46          96      9.59%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    13        192        8192       42         128      9.25%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    14        208        8192       39          80      8.12%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    15        224        8192       36         128      8.15%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    16        240        8192       34          32      6.62%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    17        256        8192       32           0      5.86%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    18        288        8192       28         128     12.16%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    19        320        8192       25         192     11.80%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    20        352        8192       23          96      9.88%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    21        384        8192       21         128      9.51%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    22        416        8192       19         288     10.71%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    23        448        8192       18         128      8.37%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    24        480        8192       17          32      6.82%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    25        512        8192       16           0      6.05%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    26        576        8192       14         128     12.33%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    27        640        8192       12         512     15.48%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    28        704        8192       11         448     13.93%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    29        768        8192       10         512     13.94%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    30        896        8192        9         128     15.52%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    31       1024        8192        8           0     12.40%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    32       1152        8192        7         128     12.41%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    33       1280        8192        6         512     15.55%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    34       1408       16384       11         896     14.00%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    35       1536        8192        5         512     14.00%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    36       1792       16384        9         256     15.57%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    37       2048        8192        4           0     12.45%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    38       2304       16384        7         256     12.46%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    39       2688        8192        3         128     15.59%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    40       3072       24576        8           0     12.47%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    41       3200       16384        5         384      6.22%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    42       3456       24576        7         384      8.83%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    43       4096        8192        2           0     15.60%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    44       4864       24576        5         256     16.65%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    45       5376       16384        3         256     10.92%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    46       6144       24576        4           0     12.48%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    47       6528       32768        5         128      6.23%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    48       6784       40960        6         256      4.36%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    49       6912       49152        7         768      3.37%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    50       8192        8192        1           0     15.61%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    51       9472       57344        6         512     14.28%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    52       9728       49152        5         512      3.64%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    53      10240       40960        4           0      4.99%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    54      10880       32768        3         128      6.24%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    55      12288       24576        2           0     11.45%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    56      13568       40960        3         256      9.99%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    57      14336       57344        4           0      5.35%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    58      16384       16384        1           0     12.49%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    59      18432       73728        4           0     11.11%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    60      19072       57344        3         128      3.57%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    61      20480       40960        2           0      6.87%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    62      21760       65536        3         256      6.25%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    63      24576       24576        1           0     11.45%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    64      27264       81920        3         128     10.00%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    65      28672       57344        2           0      4.91%
</span></span></span><span class="line"><span class="cl"><span class="c1">//    66      32768       32768        1           0     12.50%
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>每个 mspan 按照它自身的属性 Size Class 的大小分割成若干个 object，每个 object 可存储一个对象。并且会使用一个位图来标记其尚未使用的 object。属性 Size Class 决定 object 大小，而 mspan 只会分配给和 object 尺寸大小接近的对象，当然，对象的大小要小于 object 大小。</p>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Tosone</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2020-10-24
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://www.tosone.cn/tags/golang/">Golang</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/node-iojs/">
            <span class="next-text nav-default">[转] NodeJs 的那点历史</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:i@tosone.cn" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/tosone" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="http://weibo.com/gyguoyu" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>


<a href="https://www.tosone.cn/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2016 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Tosone
        
      </span></span>

  
  

  
    <span>
      <a href="http://beian.miit.gov.cn" target="_blank">豫ICP备16023221号</a>
    </span>
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
